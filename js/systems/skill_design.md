# 武學與戰鬥系統設計文件 (Skill & Combat Design Document)

本文件定義了遊戲中的核心戰鬥機制、資源運作邏輯，以及玩家與敵方的武學流派設計規範。開發者在新增招式、氣場或敵人時，請務必遵循此文件的底層邏輯。

---

## 壹、 核心戰鬥資源：氣力與破綻系統 (Combo & Flaw System)

戰鬥中的行動不僅受到 ATB (行動條) 的限制，更受到「氣力值 (Combo Cost)」的嚴格控管。這是一個強調「風險與回報」的博弈系統。

### 1. 氣力值上限公式 (Max Combo)
為了避免高靈巧角色達成無限連段的數值崩壞，氣力上限採用了「曲線壓縮」設計：
* **公式**：`30 + (原本由靈巧與身法衍生的數值 / 2)`
* **設計目的**：保障低靈巧角色的下限（起步至少有 40~50），並嚴格限制高靈巧角色的上限（極難超過 150），讓玩家必須精算每一次出招。

### 2. 破綻判定與漸進式風險 (Flaw Check)
每施放一招後，系統會根據「剩餘氣力值」進行連擊失敗（破綻）判定：
* **絕對安全區 (≥ 50)**：剩餘氣力在 50 以上時，連擊失敗率為 `0%`。
* **風險遞增區 (< 50)**：剩餘氣力低於 50 時，失敗率會線性上升，最高達到 `75%`。
  * *公式*：`失敗率 = ((50 - 剩餘氣力) / 50) * 75%`

### 3. 透支與力竭懲罰 (Overdraft & Exhaustion)
玩家可以選擇「孤注一擲」，強制施放會讓氣力值變成**負數**的招式：
* **透支狀態**：當 `currentCombo < 0` 時，角色進入「力竭」狀態。
* **力竭懲罰**：處於力竭狀態受擊時，**硬功防禦 (fixDef) 強制歸零，護體真氣 (pctDef) 效果減半**。

### 4. 動態破綻標籤 (Flaw Tags)
當連擊判定失敗時，角色將會被迫中斷攻勢，並獲得對應的懲罰：
* **標籤堆疊**：角色會獲得與「該回合已出招數量」相等的 `破綻` 標籤（貪刀越多，破綻越多）。
* **傷害加深**：敵人每次命中帶有 `破綻` 標籤的目標時，會消耗 1 層標籤，並造成 **1.5 倍的最終傷害**。
* **重置機制**：`破綻` 標籤會在角色下一次 ATB 滿 100（回合重新開始）時自動清空。

---

## 貳、 玩家專屬流派：五大行系統 (The Five Elements System)

玩家的武學嚴格遵循「勢、道、念、音、策」五大流派設計。每個流派都有專屬的運作邏輯與戰鬥節奏。

### ⚔️ 【勢】系：霸王玄鐵劍法 (物理極致爆發流)
* **核心標籤**：`["勢", "發勁", "鈍"/"銳"]`
* **流派特色**：大開大闔，高氣力消耗，極易產生破綻，強調「單發核彈」與「防禦反擊」。
* **運作機制**：
  1. 透過挨打或起手式疊加專屬氣場【霸意】與【霸體】。
  2. 消耗【霸意】可以打出無視部分防禦的破甲攻擊。
  3. 終極大招「霸王卸甲」會清空所有霸意，轉化為毀滅性的傷害倍率。

### 🔮 【道】系：奇門五行術 (環境陷阱連鎖流)
* **核心標籤**：`["道", "激發", "機"/"術", "佈置"]`
* **流派特色**：智商壓制，不依賴直接攻擊，透過「佈局 ➔ 催化 ➔ 引爆」造成巨額真實傷害。
* **運作機制**：
  1. 在「戰場環境 (Env)」中留下大量的機關暗器、火種與冰錐。
  2. 利用「風」屬性法術捲起環境物件造成多段連擊。
  3. 終極大招「五雷天罡陣」強制引爆場上所有陷阱，觸發【萬機殉爆】與【冰火兩儀爆】。

### 📿 【念】系：達摩易筋經 (防反吸血鎖血流)
* **核心標籤**：`["念", "運氣", "空", "Aura"]`
* **流派特色**：後發制人，將敵人的攻擊轉化為自身的資源，具備雙重戰鬥型態。
* **運作機制**：
  1. 滿血時為「不動明王」：疊加【禪定】與【化勁】，受到攻擊時完全免傷、反彈真實傷害並大量吸血。
  2. 殘血時為「怒目金剛」：施展「明王怒目」將防禦轉為【怒意】。大招「萬佛朝宗」會將自身已損失的血量 1:1 轉化為極致的真實傷害進行反殺。

### 🎶 【音】系：逍遙幻音訣 (無限連段指數爆發流)
* **核心標籤**：`["音", "共鳴", "歌"/"曲", "幻"]`
* **流派特色**：極致的身法閃避，超高連擊數 (Hits)，以及沒有上限的指數型傷害增長。
* **運作機制**：
  1. 透過「凌波微步」獲得【霓裳】（最高 2 層），完美閃避攻擊並反掛印記。
  2. 利用低消耗、多段數的招式，在敵人身上瘋狂疊加【餘音】印記。
  3. 終極大招「廣陵絕響」引爆餘音，傷害倍率呈 `1.3 ^ 餘音層數` 指數暴漲。

### ♟️ 【策】系：鬼谷縱橫術 (ATB 操弄與絕對斬殺流)
* **核心標籤**：`["策", "謀定", "籌"/"謀", "識破"]`
* **流派特色**：沒有常規輸出，專注於操控時間與行動條，並尋求一擊必殺。
* **運作機制**：
  1. 透過「偷天換日」強行奪取敵方的 ATB，增加自己的行動次數。
  2. 透過「截脈神針」與「空城計」在敵人身上疊加【死穴】（最高 17 層）。
  3. 大招「一子解雙徵」發動【天機看破】。基礎斬殺線為 15%，每 1 層死穴增加 5%。若敵人血量低於斬殺線，直接造成 99999 絕對秒殺。

---

## 參、 敵方 AI 風險評估與性格機制 (AI Traits)

為了防止敵人像機器人一樣瘋狂連按導致必定觸發「破綻」，敵方在出招前會進行「風險模擬評估」。開發者可在 `db_enemies.js` 中為 Boss 設定 `aiTrait` 屬性。

* **`cautious` (謹慎型)**：
  * **邏輯**：絕對不冒險。只要下一招會讓氣力跌破 50（產生大於 0% 的破綻機率），就會主動結束回合，絕不露出破綻。
  * **定位**：高防禦、高難度、需要玩家主動破防的智將型敵人（如：莫測）。
* **`balanced` (常規型 / 預設)**：
  * **邏輯**：會嘗試連段，但絕對不會透支。當破綻機率上升時，會根據機率進行「退守檢定」（例如破綻率 40% 時，有 40% 機率主動收招）。
  * **定位**：90% 的普通敵人與常規 Boss。
* **`berserk` (狂暴型)**：
  * **邏輯**：完全不計後果。無視破綻機率，甚至願意將氣力透支至 -50，寧可防禦力歸零也要把玩家往死裡打。
  * **定位**：強調瘋狂進攻、狂化階段的敵人（如：武男）。

---

## 肆、 系統防呆與開發規範

1. **氣場層數上限**：為防止數值膨脹，所有具備極端防禦性質的氣場，必須在 `combat.js` 的 `addAura` 中註冊白名單上限（例如：【霓裳】最高 2 層，【空城】最高 1 層）。
2. **環境變數 (Env) 呼叫**：新增環境物件時，必須使用 `ctx.addEnv('type', amount)` 進行呼叫，嚴禁直接修改 `GameState.env` 陣列，以確保受限於氣力上限的安全防呆機制生效。
3. **傷害與演出分離**：招式定義檔 (`db_skills.js`) 僅處理狀態賦予與氣力消耗，複雜的傷害加乘與核彈演出必須透過寫入 `db_reactions.js` (連鎖反應) 來觸發。